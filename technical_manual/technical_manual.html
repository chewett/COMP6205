
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">

	<title>COMP6205 Assignment Brief</title>

	<!-- Bootstrap core CSS -->
	<link href="css/bootstrap.min.css" rel="stylesheet">

	<!-- CSS for the assignment Brief -->
	<link href="css/brief.css" rel="stylesheet">

	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	<script src="js/html5shiv.min.js"></script>
	<script src="js/respond.min.js"></script>
	<![endif]-->

	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	<script src="js/jquery-1.11.1.min.js"></script>
	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<script src="js/bootstrap.min.js"></script>
	<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
	<script src="js/ie10-viewport-bug-workaround.js"></script>

	<script src="js/google-code-prettify/run_prettify.js" type="text/javascript"></script>
	<link href="js/google-code-prettify/prettify.css" type="text/css">

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand active" href="#thing">COMP6205 Thing</a>
		</div>
		<div class="collapse navbar-collapse">
			<ul class="nav navbar-nav">
				<li><a href="#Thing">Thing</a></li>
			</ul>
		</div>
	</div>
</div>

<div class="container">

	<div class="main_content">

		<div class="page-header">
			<h1 id="Thing">COMP6205 Thing</h1>
		</div>
		<h2> <u>Doctrine - An ORM system</u> </h2>

			<p>
				Doctrine is one of the points we decided to learn about. It provides us with an object relational mapping in PHP.
				This allows us to access the database using PHP objects and have Doctrine write the data back to a database.
				An example of one of the mapping files is below.
			</p>
			<p>
<pre class="prettyprint">/**
 * @var string
 *
 * @Column(name="keyname", type="string", length=45, nullable=false)
 */
private $keyname;
</pre>
			</p>
			<p>
				Here we define a field in an object and the type of column it should be in the database.
				Once we have designed our entities we can then run a Doctrine export script to create the database.
				This also updates the database as we change the entities without losing data in the database.
			</p>
			<p>
				We can create objects and use them and when we want them to be written to the database doctrine will do this.
			</p>
		<p>
<pre class="prettyprint">
$mainMode = new Options;
$mainMode->setKeyname("maintenance_mode");
$mainMode->setValue("false");

$em->persist($mainMode);
$em->flush();
</pre>
		</p>
		<p>
			$em is the entity manager and deals with all the objects that we wish to write to and get from the database.
			By telling it to persist the new object it puts it in a queue to write back to the database and when flush() is called this is performed.
		</p>

			<h3> Server side validation (SQL Inject)</h3>

			<p>
				Doctrine handles SQL injection problems in many of its functions.
				When you are using the objects in the above manner Doctrine will escape all user input for you.
				It also provides prepared statements when you wish to use their own Doctrine Query Language (DQL) or SQL.
			</p>

			<h3>Generated Database schema (ORM) </h3>
			<p>
				Below is the entity relationship diagram generated from the Doctrine entities.
				Doctrine does not rely on the order of the columns so the produced database structure does not have column order order.
				This uses crows foot notation to demonstrate the foreign keys.
				<ul>
					<li>Fields that are the primary key for the table have a yellow key.</li>
					<li>Fields that are a foreign key have a purple icon.</li>
					<li>Fields that are required have a blue icon.</li>
					<li>Fields that are not required have a white icon.</li>
				</ul>
			</p>

			<p>
				<img class="img-responsive" src="images/ER_diagram.png" />
			</p>
			<h3> Transaction consistency, ACID properties </h3>

			<p>
				Doctrine has transaction handling already built in.
				Each time an entity is modified or persisted then it is queued.
				When you call flush on the Entity Manager then it will run the SQL operations in one transaction.
				This gives you transaction consistency without having to do it yourself.
			</p>

			<h3>Critical evaluation </h3>

			<p>
				Doctrine was very helpful for the transaction and SQL injection handling abilities and using objects in PHP makes it much easier than trying to keep a database and set of objects in sync.
				Using the ORM in PHP means that you can use more OOP and use objects to relate to the actual tables.
				In doing this we didnt have to write any SQL and only a small bit of DQL to do the more advanced parts of the website.
			</p>

		<h2> <u>Role based authentication</u> </h2>
		
			<p>
				We spent some time working on creating a role based system to permit/deny access to parts of the website.
				By researching we decided to split the data into three different tables in the database.
			</p>
			
			<p>
				<ul>
					<li>Roles - This table stores a list of roles that users could have. One user has one specific role</li>
					<li>Permissions - This table stores a list of possible permissions a role could have. These permissions let you access functionality of the website</li>
					<li>RoleHasPermissions - This table links 1 role to 1 permission. This is needed to ensure 3rd normal form is kept in the database.</li>
				</ul>
			</p>
			
			<p>
				By having a list of permissions to access pages rather than deciding on roles that can access pages we have improved coding and reduced the time required to add new roles.
				A common problem without having pasermission based role authentication is that the ability to access a page will often be checked by the role the user has.
				This then means that if a new role is added all the pages need to be edited that the role can access.
				By having a permission based system you give that user the permissions it needs to complete its job and all the previous pages accept that user provided they have the permissions.
				This reduces the need for ongoing system maintene and means non-techincal users can create new roles as and when needed.
			</p>

		<h2> Bootstrap</h2>
			<p>
				We have used Twitter Bootstrap system to style the website and utlising some of their design patterns.
				This was so that we could focus on getting a site that looked good and worked well on a range a devices to focus on learning in our chosen areas.
			</p>
		
			<h3> Responsive site, working on mobile devices </h3>
			
			<p>
				Bootstrap provide a base level of responsive design that allows you to create a website that works well on mobile devices.
				Provided you design your site correctly it will be able to scale to smaller screen devices.
				We have spent some time ensuring that webpages scale to smaller sized screens so that most of the functionlity was still present.
				This is to acknowledge the trend that many forms of web browsing is now on phones an tablets. 
			</p>
			
			<h3> Input client side validation </h3>

			<p>
				Previously we wished to spend a bit of time learning to use the Dojo JavaScript library to make text inputs which validated the input.
				After some work with bootstrap we found that bootstrap actually does this very well so decided to simplify our plan.
				This was helpful as neither of us had much experiance with this library and we would have had to spend a fair bit of time learning to use it.
			</p>

		<h2> Unit Tests</h2>
			<p>
				To ensure that we do not introduce bugs we have written a number of unit tests to exhaustively test the functions and main parts of the website.
				As part of our development process it was recommended to run these tests before each commit so that we could fix any problems we caused in the commit before it committed.
			</p>
			<p>
				These tests were written using the phpunit framework and all tests can be found in the <code>unittests</code> directory.
				Theses tests could be run with <code>phpunit .</code>. An example of what the output looks like when ran is below.
			</p>
			<p>
				<img class="img-responsive" src="images/phpunit.png" />
			</p>
			<p>
				An example test written to test our permission function is reproduced below.
				The full source code for this file is available in <code>unittests/HashingFunctionTest.php</code>
			</p>
			<p>
<pre class="prettyprint">/**
 * This tests the verifyLoginPassword function to see if it will verify valid and invalid passwords
 * @depends testGenerateHashIsUnique
 * @param $hashs a list of hashes generated above with the password "Easy_Password"
 */
public function testValidLogin($hashs) {
	foreach($hashs as $hash) {
		$this->assertTrue(verifyLoginPassword("Easy_Password", $hash));
		$this->assertFalse(verifyLoginPassword("Wrong_Password", $hash));
	}

}
</pre>
			</p>
			<p>
				This test is given a list of hashes from a previous test.
				These hashes are all salted hashes with the password "Easy_Password".
				Here we test the function <code>verifyLoginPassword</code> and pass it a valid and invalid password.
				We use <code>assertTrue</code> and <code>assertFalse</code> to check if the function returns the expected value.
				Any failure in assertion will cause this test to fail and report back the expected and actual value.
			</p>

		<h2>Coding Standards</h2>
			<p>
				While programming this website we tried to, for the most part, adheer to PSR-1 basic coding standards.
				You can find the PSR-1 standards <a href="http://www.php-fig.org/psr/psr-1/">online</a>.
			</p>

		<h2> 404 page </h2>

		<p>
			We have used a <code>.htaccess</code> page to ensure that any people who visit a URL that is not found on our webserver get a more helpful screen.
			Below is the content of the <code>.htaccess</code> page.
		</p>

		<pre class="prettyprint">ErrorDocument 404 /comp6205/website/404.php</pre>

		<h3>Before adding .htaccess page</h3>
		<img class="img-responsive" src="images/not_found_bad.png" />

		<h3>After adding .htaccess page</h3>
		<img class="img-responsive" src="images/not_found_good.png" />

		<p>
			This will hopefully mean that they do not get put off by the default 404 page and it points them at a page that does exist.
		</p>

		<h2> Dynamic templates (hiding/showing content based on user) </h2>

			<p>
				Since neither of us had used templating libraries we decided that we would not spend time looking into and learning one of these to focus on our two main areas.
				We have however used a dynamic template written using PHP to help us develop the site easier.
			</p>
			<p>
				All webpages included basic header and footer templates which made each page look similar to like:
			</p>
			<p>
<pre class="prettyprint">&lt;?php
$pageRequiresLogin = true;
$pageTitle = 'Account Overview';
require_once 'inc/setup.php';
require_once 'inc/header.php';
?&gt;

Page Content

&lt;?php
require_once 'inc/footer.php';
</pre>
			</p>
		<p>
			Here we set up templates for the header and the footer of the page and then included them on all the pages that we needed them on.
			This gave us a common look across the whole website and mean that we did not have to alter every page when we wished to change something on the header or footer.
			This therefore decreased the amount of work we needed to do.
		</p>
		<p>
			The template is also dynamic as the page title and whether the page requires you to be logged in is set in variables then used in the header.
			It will also load additional tabs along the top of the page depending on your role permissions as shown in the below snippet:
		</p>
		<p>
<pre class="prettyprint">&lt;?php
//display the admin tab only if user is logged in and has at least one of the roles below
if(isset($_SESSION['id_user']) && $_SESSION['id_user']){
	if((userHasPermission("admin_users_assign") ||
	userHasPermission("admin_view_roles") ||
	userHasPermission("admin_view_permission") ||
	userHasPermission("admin_view_concerns") ||
	userHasPermission("admin_site_options"))) {
		echo '&lt;li&gt;&lt;a class="navbar-brand active" href="admin.php"&gt;Admin&lt;/a&gt;&lt;/li&gt;';
	}
}
?&gt;
</pre>
		</p>

		<h2> AJAX: reload page to dynamically update transactions list </h2>

			<p>
				The view transaction page uses AJAX calls to dynamically update the page as and when changes are made.
				This will reload the current transactions every 10 seconds and update the table.
				<code>loadTransactions.php</code> gets the data from the database and outputs JSON which is then loaded by the <code>bankOverview.php</code>
			</p>

		<p>
<pre class="prettyprint">setInterval(updateTransaction, 10000);

function updateTransaction() {
	console.log("Loading transaction");
	$.getJSON("loadTransactions.php?id=<?=$bankAccount->getIdBankaccount()?>", '', replaceTransaction);
}</pre>
		</p>

		<p>
			Here we use the jQuery <code>$.getJSON()</code> method to load the transactions page and then once loaded call the callback function <code>replaceTransactions</code> which updates the information on the page.
			We tell the page to load this every 10 seconds with <code>setInterval()</code> which will run the update function.
		</p>

		<h2>PDF Statement Creation</h2>

		<p>
			To create a PDF we create a latex file and then compile it on the server with the below code
			<pre class="prettyprint">exec("cd " . dirname(__FILE__) . "/../statements; pdflatex {$guid}.tex > pdflatex_statement_creation.log");</pre>
			This invokes pdflatex which creates the pdf and then later in the function we return the location of the new statement.
			Calling exec is bad however all user input will be sanitised and therefore the user will not be able to take control of this risky system call.
			A possible extension would be to use a PHP pdf creation library however for this example pdflatex suffices.
		</p>
		<p>
			An example of the created statement is <a href="statement_example.pdf">available</a>
		</p>

		<h2> Disable access to guessable pages such as admin.php </h2>

			<p>
				As a security procedure and as part of our permission checking all pages that require permissions are checked to ensure the user has them.
				Any users visiting pages that they are not allowed to visit will have the below error shown.
			</p>

			<p>
				<img src="images/cannot_access_page.png" />
			</p>

		<h2> Password hashing and salting </h2>

		<p>
			To keep the users password secure we have decided we will hash and salt the passwords.
			The three functions that deal with this are in <code>/inc/auth.php</code>.
		</p>
		<p>
			We use the PHP <code>crypt($password, $salt)</code> function to properly hash the passwords and use blowfish hashing.
			This ensures that a users password is not stored in plaintext and as there is a salt used it makes bruteforcing of passwords much trickier.
		</p>
		<p>
			Therefore passwords are stored in the database like <code>$2y$10$4cd8ef6781c5e9e99d0a7ulXV3QNdg2gFIhcSndVMDRgHZVxVGodW</code>.
		</p>

		<h2>CSRF - Not yet implemented</h2>

		<h2>Linking to external JS and not ours</h2>

		<p>
			Where possible we have linked to the Google hosted libraries we have used.

			In <code>/inc/header.php</code> we link to the jQuery library hosted by Google.
		</p>

		<pre class="prettyprint">&lt;script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"&gt;&lt;/script&gt;</pre>
		<p>
			This has a number of added benefits:
			<ul>
				<li>
					Google will be able to serve these large files much faster than we can.
					This is because they will have a large number of local servers and using IP anycast.
					These servers will also likely be much faster than ours due to their large data centers.
				</li>
				<li>
					This reduces the amount of data to be loaded off our site and improves loading time as browsers normally will only load a certain number of resources from one domain at a time.
				</li>
				<li>
					There are caching benefits as if a user has visited a website this includes jQuery from the Google CDN previously it will load this page from the cache speeding up pageload time.
				</li>
				<li>
					Google provide http and https versions of this file and the URL we have linked to does not start with a protocol definintion.
					Instead we use <code> src="//ajax.googleapis.com/...</code>.
					This means that it will use whatever protocol the page uses it will request the content as.
					This stops us having to write code to dynamically determine what protocol we are using or serving insecure http content alongside secured https content.
				</li>
			</ul>
			This reduces the amount of data to be loaded off our site and improves loading time as browsers normally will only load a certain number of resources from one domain at a time.

			This also has caching benefits as if a user has visited a website this includes jQuery from the Google CDN previously it will load this page from the cache speeding up pageload time.
		</p>

		<h2>Content used</h2>

		<h3>Google Prettify</h3>

		<p>For this manual we have used Google prettify which can be downloaded <a href="https://code.google.com/p/google-code-prettify/">here</a></p>

	</div>

</div><!-- /.container -->
</body>
</html>
